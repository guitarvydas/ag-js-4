<html>
  <head>
    <title>SVG to Factbase</title>
    <meta charset=utf-8>
    <!-- <script src="https://github.com/harc/ohm/tree/master/ohm-js/dist/ohm.js"></script> -->
    <script src="./ohm.js"></script>

    <script type="text/ohm-js">
SchematicDiagramGrammar {
  SchematicDiagram = "<html>" NotSVG+ SVGsection NotHTMLend+ "</html>"
  SVGsection = "<svg" WH ">" (Rect | Text)+ "</svg>"
  
  Rect = "<rect" ID XYWH ">" "</rect>"
  Text = "<text" ID XY ">" HTMLchar+ "</text>"
  
  ID = "id=" NumString
  NumString = "\"" digit+ "\""
  XYWH = XY WH
  XY = "x=" NumString "y=" NumString
  WH = "width=" NumString "height=" NumString
  HTMLchar = ~">" ~"<" any
  NotSVGend = ~"</svg>" any
  NotSVG = ~"<svg" any
  NotHTMLend = ~"</html>" any
}
</script>

<!-- 
     Note that the test string contains no single quotes itself.
     The test string is quoted by JavaScript backtick quotes ("template literals").
  -->
    
    <script>
    var testString = `
	<html>
	  <title>Top</title>
	  <head>
	    <style>
	      rect { fill:#DAE8FC }
	    </style>
	  </head>
	  <body>

	    <h1>Top Part (Schematic)</h1>

	    <svg width="800" height="800">
	      <rect id="0" x="40" y="120" width="150" height="60"></rect>
	      <rect id="1" x="40" y="320" width="150" height="60"></rect>
	      <rect id="2" x="280" y="120" width="250" height="130"></rect>
	      <rect id="3" x="650" y="120" width="150" height="60"></rect>
	      <rect id="4" x="650" y="270" width="150" height="60"></rect>
	      <rect id="5" x="650" y="360" width="150" height="60"></rect>
	      <rect id="6" x="650" y="440" width="150" height="60"></rect>

	      <text id="7" x="50" y="150" >FileSelector</text>
	      <text id="8" x="50" y="350" >TimeoutTimer</text>
	      <text id="9" x="290" y="185" >CallbackLogic</text>
	      <text id="10" x="660" y="150" >Display</text>
	      <text id="11" x="660" y="320" >ErrorHandler</text>
	      <text id="12" x="660" y="410" >AbortHandler</text>
	      <text id="13" x="660" y="490" >NoResponseHandler</text>

	    </svg>

	  </body>
        </html>
	`;
</script>

    <script>

      var grammars = ohm.grammarsFromScriptElements();
      var SchematicDiagram_grammar = grammars["SchematicDiagramGrammar"];
      var SchematicDiagram_semantics = SchematicDiagram_grammar.createSemantics();
      
      function toPackedString(a) {
	  return a.join('');
      }

      Schematicdiagram_semantics.addOperation(
	  'toFB',
	  {
	      SchematicDiagram: function (_begin, _notSVG, svg, _notHTML, _end) { return svg.toFB(); },
	      SVGsection: function (_svg, wh, _close, contents, _end) {
		  //var str = `script>\nconsole.log("begin");\nfunction fact(){};\n${contents.toFB().join('\n')}\n`;
		  var str = `script type="text/factbase">\nconsole.log("begin");`;
		  str = "<" + str + `console.log("end");\n` + "<" + "/script>";
		  console.log (str);
		  return str;
	      },
              Rect: function (_begin, idTree, xywhTree, _close, _end) { 
		  var result =[];
		  var id = idTree.toFB ();
		  var xywh = xywhTree.toFB ();
		  result.push (`fact ("rect_x", "${id}", ${xywh[0]});`);
		  result.push (`fact ("rect_y", "${id}", ${xywh[1]});`);
		  result.push (`fact ("rect_w", "${id}", ${xywh[2]});`);
		  result.push (`fact ("rect_h", "${id}", ${xywh[3]});`);
		  return result.join('\n'); 
	      },
              Text: function (_begin, idTree, xyTree, _close, chars, _end) {
		  var result =[];
		  var id = idTree.toFB ();
		  var xy = xyTree.toFB ();
		  result.push (`fact ("text_x", "${id}", ${xy[0]});`);
		  result.push (`fact ("text_y", "${id}", ${xy[1]});`);
		  result.push (`fact ("text_text", "${id}", "${chars.toFB().join('')}");`);
		  return result.join('\n'); 
	      },
              ID: function (_id, numstr) { return "id" + numstr.toFB (); },
              NumString: function (_q1, digits, _q2) { return parseInt (toPackedString(digits.toFB())); },
              XYWH: function (xy, wh) { return xy.toFB().concat (wh.toFB ()); },
              XY: function (_x, xstring, _y, ystring) { return [xstring.toFB (), ystring.toFB ()]; },
              WH: function (_w, wstring, _h, hstring) { return [wstring.toFB (), hstring.toFB ()]; },
              HTMLchar: function (c) { return c.toFB(); },
              NotSVGend: function (c) { return c.toFB(); },
              NotSVG: function (c) { return c.toFB(); },
              NotHTMLend: function (c) { return c.toFB(); },

	      _terminal: function() { return this.primitiveValue; }
          });      

</script>

    <script>
      function displayDate () {
	  document.getElementById('timestamp').innerHTML = Date();
      }

      function displayFB() {
	  var parseTree = SchematicDiagram_grammar.match (testString);
	  if (parseTree.failed()) {
	      document.getElementById('result').innerHTML = "**FAILED**";
	  } else {
	      var fb = SchematicDiagram_semantics(parseTree).toFB()
	      document.getElementById('result').innerHTML = fb;
	  }
	  displayDate ();
      }
    </script>
    
  </head>
  <body>
    <button onclick="displayFB()">Create Factbase</button>
    <p id="timestamp"></p>
    <p id="result"></p>
  </body>
</html>
